# 第9章——使用网络技术

## 9.1 WebView的用法

我们使用一个新的控件：WebView。这个控件用来显示网页。

```xml
    <WebView
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:id="@+id/web_view" />
```

在活动的主文件中：

```java
        WebView webView = (WebView) findViewById(R.id.web_view);
        webView.getSettings().setJavaScriptEnabled(true);
        webView.setWebViewClient(new WebViewClient());
        webView.loadUrl("http://www.baidu.com");
```

*    `getSetting()`方法可以设置一些浏览器的属性，这里调用`setJavascriptEnabled()`方法来让WebView支持Javascript脚本。
*    `setWebViewClient()`方法接收一个WebViewClient类的实例。**表示从一个网页跳转到另一个网页时，我们希望网页仍然在WebView中显示，而不是打开系统浏览器。**
*    `loadUrl()`方法将网址传入，即可展示相应的网页内容。
*    在AndroidManifest.xml中需要申明访问网络功能的权限：

```xml
    <uses-permission android:name="android.permission.INTERNET" />
```



## 9.2 使用HTTP协议访问网络



### 9.2.1 使用HttpHRLConnection



发送HTTP请求通过**HttpURLConnection**的方法。

1.   首先获取到HttpURLConnection实例，new 出一个URL对象，再通过URL对象的`openConnection()`方法即可：

```java
URL url = new URL("https://www.baidu.com");
HttpURLConnection connection =(HttpURLConnection) url.openConnection();
```

**注意：**这里有个问题，如果地址填写的是`http://www.baidu.com`，会报错：`No Network Security Config specified, using platform default`，可以参阅[网络安全性配置](https://developer.android.com/training/articles/security-config.html)

2.   通过HttpURLConnection的`setRequestMedthod()`方法可以设置HTTP请求所使用的方法，接收的参数有两个：`GET`和`POST`
3.   通过HttpURLConnection的其他API方法来进行自由定制。

```java
connection.setConnectTimeout(8000);
connection.setReadTimeout(8000);
```

4.   再调用`getInputStream()`方法就可以获取到服务器返回的输入流，之后可以对这个输入流进行数据处理：

```java
InputStream in = connection.getInputStream();
reader = new BufferedReader(new InputStreamReader(in));
StringBuilder response = new StringBuilder();
String line;
while ((line = reader.readLine())!=null){
	response.append(line);
}
```

5.   最后调用`disconnect()`将这个HTTP连接关闭掉：

```java
connection.disconnect();
```



如果是使用POST请求，**需要在获取输入流之前把要向服务器提交的数据写出来**。

每条数据都要以键值对的形式存在，数据与数据之间用`&`符号隔开：

```java
connection.setRequesrMethod("POST");
DataOutputStream out = new DataOutputStream(connection.getOutputStream());
out.writeBytes("usename=admin&password =123456");
```



### 9.2.2 使用OkHttp开源库

首先**引入OkHtto库的依赖**：

```xml
    testCompile 'com.squareup.okhttp3:mockwebserver:3.9.0'
```

*    首先需要创建一个OkHttpClient的实例：

```java
OkHttpClient client = new OkHttpClient();
```

*    创建一个Request对象：

```java
Request request = new Request.Builder().build();
```

上面只是创建了一个空的Request对象，可以使用连缀的方法来丰富这个对象：

```java
Request request = new Request.Builder()
                            .url("https://www.baidu.com")
                            .build();
```

*    获取服务器返回的数据，通过调用OkHttpClient的`newCall()`方法创建一个Call对象，再调用该对象的`execute()`方法发送请求。

```java
Response response = client.newCall(request).execute();
```

其中Response对象就是服务器返回的数据，我们可以使用如下写法来得到返回的具体内容：

```java
String responseData = response.body().string();
```

*    最后切换到主线程，把数据显示在布局中：

```java
runOnUiThread(new Runnable() {
            @Override
            public void run() {
                responseText.setText(response);
            }
        });
```



**如果是POST请求**

*    首先构建一个RequestBody对象来存储待提交的参数：

```java
RequestBody requestBody = new FormBody.Builder()
  .add("username","admin")
  .add("password","123456")
  .buid();
```

*    在Request.Builder()中连缀一个`.post(requestBody)`方法，传入刚才创建的RequestBody对象：

```java
Request request = new Request.Builder()
  .uri("http://www.baidu.com")
  .post(requesrBody)
  .build();
```

接下来操作和GET请求的操作完全一样，获取服务器返回的数据，并显示在布局中。

## 9.3 解析XML格式数据





## 9.4 解析JSON格式数据



## 9.5 网络编程的最佳实践

